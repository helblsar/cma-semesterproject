# Project - Computational Movement Analysis

```{r, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
``` 


## Loading necessary libraries
```{r Libraries, include=FALSE}
library(ComputationalMovementAnalysisData)
library(dplyr)
library(lubridate)
library(sf)
library(ggplot2)
```
The Computational Movement Analysis Data contains: 
- wildboar data: wildschwein_BE, wildschwein_metadata, wildschwein_overlap_temp
- wildschwein schreck data: schreck_agenda, schreck_locations

## Loading the necessary data

```{r RawData}
# Metadata
meta_d<-wildschwein_metadata
boars_sex<-meta_d%>%
  select(TierID,Sex)

# Boar data
boars<-wildschwein_BE
boars<-inner_join(boars, boars_sex, by="TierID")%>%
  st_as_sf(coords=c("E","N"), crs=2056, remove=FALSE)%>%
  distinct()

# Separating the boar data based on the sex
f_boars<-boars %>%
  filter(Sex=="f")%>%
  group_by(TierID)%>%
  arrange(DatetimeUTC, .by_group=TRUE)%>%
  tibble::rowid_to_column("rowid")
m_boars<-boars %>%
  filter(Sex=="m")%>%
  group_by(TierID)%>%
  arrange(DatetimeUTC, .by_group=TRUE)%>%
  tibble::rowid_to_column("rowid")

rm(boars, boars_sex)

# Deterrence data
det_loc<-schreck_locations
det_a<-schreck_agenda

# joining the deterrence locations and the deterrence agenda
deterrence<- inner_join(det_a, det_loc, by="id")
deterrence<-st_as_sf(deterrence, coords=c("lon", "lat"), crs=4326, remove=FALSE)
det_CH<-st_transform(deterrence, 2056)
rm(deterrence, det_loc, det_a)
```

With the necessary data prepared, the deterrence locations are buffered with a 500m buffer. To determine which boars came into contact with the deterrence locations a spatial join is done to connect the buffers with the boars. The joined data is then filtered by the activity of the deterrence noise.
```{r }
# create different buffers around deterrence locations
det_buffer<-st_buffer(det_CH, 500)
#det_buffer_250<-st_buffer(det_CH, 250)
#det_buffer_100<-st_buffer(det_CH, 100)
#ggplot()+
 # geom_sf(data=det_buffer, fill="grey", alpha=0.4)+
  #geom_sf(data=det_buffer_250,fill="blue", alpha=0.3)+
#  geom_sf(data=det_buffer_100, fill="green", alpha=0.3)+
 # coord_sf(datum=2056)+
  #xlim(2560000, 2580000)+
#  ylim(1200000, 1220000)
```


```{r }
# join
#f_join_100<-st_join(f_boars, det_buffer_100, left=FALSE)
f_join_500<-st_join(f_boars, det_buffer, left=FALSE)
#m_join_100<-st_join(m_boars, det_buffer_100, left=FALSE)
m_join_500<-st_join(m_boars, det_buffer,left=FALSE)


# check if deterrence was active during the encounter
#f_active_500<-f_join_500 %>%
 # group_by(TierName) %>%
 # mutate(active=DatetimeUTC %within%interval(ymd(datum_on),ymd(datum_off))) %>%
#  filter(active==TRUE)%>%
 # distinct()
f_active<-f_join_500 %>%
  mutate(active=DatetimeUTC %within%interval((ymd(datum_on)+hours(-12)),
                                             (ymd(datum_off)+hours(12)))) %>%
  filter(active==TRUE)%>%
  distinct()
#m_active_500<-m_join_500 %>%
 # group_by(TierName) %>%
  #mutate(active=DatetimeUTC %within%interval(ymd(datum_on),ymd(datum_off))) %>%
#  filter(active==TRUE)%>%
 # distinct()
m_active<-m_join_500 %>%
  mutate(active=DatetimeUTC %within%interval((ymd(datum_on)+hours(-12)),
                                             (ymd(datum_off)+hours(12)))) %>%
  filter(active==TRUE)%>%
  distinct()

# removing points with consecutive rowids' to avoid counting the same encounter several times
f_unique<-f_active %>%
  mutate(id_diff=abs(rowid-lag(rowid, default = 46))) %>%
  filter(id_diff>46)
m_unique<-m_active %>%
  mutate(id_diff=abs(rowid-lag(rowid, default = 46))) %>%
  filter(id_diff>46)#?????!!!!!!!!!!!!!!!!!!!!

## ID_diff >48 is based on the idea, that, in a later step, all those IDs get selected that are within a 12h time-window of this one ID (that encounter) if IDs are still in there that are too close together they are going to be selected as separate encounters --> it might not perfectly reflect the 6h before and 6h after an encounter, but it is a compromise that helps to avoid having seemingly different encounters despite the wild boar not even having left the buffer-zone in the first place 
rm(f_join_500, m_join_500)
```
Next steps?

because certain buffers are spatially intersecting with each other, while the deterrence is also active at the same time, some boar tracking-points are twice in the data --> solved via `distinct`
however --> what I am interested in, is how a certain animal reacts after encountering a deterrence noise --> therefore such double/triple entries are not that concerning --> rather it is going to be complicated in general to define a time-window in which I define certain movement/behavior patterns after an animal encounters the deterrence noise --> filtering in the original boar_f/ boar_m dataset for those encounter points and see what happens in the consecutive steps --> is it even possible to detect if an animal came back...

Function that matches the boar data with the timewindow within which a boar encountered an active deterrence site and selects all those instances
```{r }
#Function to filter for those points that are within a given time window and belong to a certain animal
inInterval<-function(boardata, timewindow, animalID){
  filter(boardata, DatetimeRound %within% timewindow,
         TierID==animalID)
}
```


```{r }
# preparing the encounter data
f_timewindows<-f_unique %>%
  mutate(DatetimeRound=round_date(DatetimeUTC, "15 minutes"),
         Timewindow=interval(DatetimeRound+hours(-6), DatetimeRound+hours(6))) %>%
  distinct()

m_timewindows<-m_unique %>%
  mutate(DatetimeRound=round_date(DatetimeUTC, "15 minutes"),
         Timewindow=interval(DatetimeRound+hours(-6), DatetimeRound+hours(6))) %>%
  distinct()

# prepare the boars data
f_boars<-mutate(f_boars, DatetimeRound=round_date(DatetimeUTC, "15 minutes"))
m_boars<-mutate(m_boars, DatetimeRound=round_date(DatetimeUTC, "15 minutes"))
```

```{r }

# filter out all the relevant rowids that reflect point 6h before and 6h after an encounter
#females
rowid<-numeric()
meetings<-numeric()
meet_id<-numeric()
nr_rows<-c(1:nrow(f_timewindows))
for (i in nr_rows){
  match=inInterval(f_boars, f_timewindows$Timewindow[i], f_timewindows$TierID[i])
  match=distinct(match)
  rowid=c(rowid, match$rowid)
  len=nrow(match)
  meetings=c(meetings,len)
  meet_id=c(meet_id,rep(i, times=meetings[i]))
}
#filter for all relevant data points from the females dataset
matches<-as.data.frame(rowid)
matches<-cbind(matches, meet_id)
f_relevant<-matches %>%
  inner_join(f_boars, by="rowid") %>%
  distinct() %>%
  st_as_sf(crs=2056) %>%
  select(rowid, meet_id, DatetimeRound, geometry, E, N) %>% 
  group_by(meet_id)
```

```{r }
# males
rowid<-numeric()
meetings<-numeric()
meet_id<-numeric()
nr_rows<-c(1:nrow(m_timewindows))
for (i in nr_rows){
  match=inInterval(m_boars, m_timewindows$Timewindow[i], m_timewindows$TierID[i])
  match=distinct(match)
  rowid=c(rowid, match$rowid)
  len=nrow(match)
  meetings=c(meetings,len)
  meet_id=c(meet_id,rep(i, times=meetings[i]))
}
# filter all relevant data points from the females dataset
matches<-as.data.frame(rowid)
matches<-cbind(matches, meet_id)
m_relevant<-matches %>%
  inner_join(m_boars, by="rowid") %>%
  distinct() %>%
  st_as_sf(crs=2056) %>%
  select(rowid, meet_id, DatetimeRound, geometry, E, N) %>%
  group_by(meet_id)


rm(meet_id,meetings, nr_rows,i,len, matches, match, rowid, f_timewindows,m_timewindows)
```


--> What now?
The separate encounters of wild boars with an active deterrence are now singled out. 
Now the question is, what kind of movement parameters I want to derive. I have speed and 
timelag, but those are only two measures. 
TO use similarity measures, I would have to further separate them by det location, 
but technically this should be possible by once again spatially joining the "relevant" 
datasets with the deterrence buffer --> This could also help to determine how long a 
wild boar has actually spent in a certain range of the active deterrence. Also if I have 
the data split up like this, I could go on to compare the reactions with different deterrence
"settings" (Lautstaerke, Hoehe, ...).

```{r }
# join the encounters once again with features of the deterrence

f_rel<-f_relevant %>%
  st_drop_geometry()%>%
  select(rowid, meet_id)

m_rel<-m_relevant %>%
  st_drop_geometry()%>%
  select(rowid, meet_id)


# prepare deterrence features
f_det<-f_unique %>%
  st_drop_geometry() %>%
  select(rowid, id, modus, lautstaerke, intervall, ausrichtung_min,
         ausrichtung_max, phase, kultur, installationshohe, zaun, jagddruck)

m_det<-m_unique %>%
  st_drop_geometry() %>%
  select(rowid, id, modus, lautstaerke, intervall, ausrichtung_min,
         ausrichtung_max, phase, kultur, installationshohe, zaun, jagddruck)

# the join itself - but oh, what a surprise, sf objects and simple dfs can't be joined

f_deterrence<-inner_join(f_rel, f_det, by="rowid")
m_deterrence<-inner_join(m_rel, m_det, by="rowid")

```


```{r }
# finally prepare for the join of the relevant points with the available deterrence data
f_rel<-f_relevant %>%
  st_drop_geometry() %>%
  select(rowid, meet_id, DatetimeRound, E, N)
m_rel<-m_relevant %>%
  st_drop_geometry() %>%
  select(rowid, meet_id, DatetimeRound, E, N)


f_joined<-left_join(f_rel, f_deterrence, by="meet_id")
m_joined<-left_join(m_rel, m_deterrence, by="meet_id")

f_encounters<- st_as_sf(f_joined, coords=c("E","N"), crs=2056, remove=FALSE)
m_encounters<- st_as_sf(m_joined, coords=c("E","N"), crs=2056, remove=FALSE)

rm(f_rel, m_rel, f_det, m_det,f_deterrence, m_deterrence, f_joined, m_joined, f_relevant,m_relevant)
```




The data should now theoretically be ready for some movement pattern analysis
I need to find stuff that I can compare (speed, flight distance,...). But first - let's check the data first.

```{r, include=FALSE}
length(unique(f_encounters$rowid.x))==nrow(f_encounters)
nrow(f_encounters)/length(unique(f_encounters$meet_id)) 
# 12h should technically (with the 15min. sampling interval) result in 48 points, but since sampling is only every few hours during the day, it's only logical as I selected by "within time interval" and not +/- a certain number of ids'
length(unique(m_encounters$rowid.x))==nrow(m_encounters)
nrow(m_encounters)/length(unique(m_encounters$meet_id))

```



```{r }
# getting an overview
#plotting all movements of female wild boars within a 12h window of an encounter with a deterrence
f_buffer<-filter(det_buffer, id %in% unique(f_encounters$id))
m_buffer<- filter(det_buffer, id %in% unique(m_encounters$id))

f_encounters_buffer<-ggplot()+
  geom_sf(data=f_buffer, fill="grey", alpha=.4, color="grey")+
  geom_sf(data=f_encounters, aes(colour=meet_id), size=0.4)+
  geom_path(data=f_encounters, aes(E, N), color="grey", alpha=0.5)+
  #facet_wrap(~meet_id)+
  theme(legend.position = "none")+
  coord_sf(datum=2056)+
  xlim(2568000, 2575000)+
  ylim(1202000, 1208000)
f_encounters_buffer  

m_encounters_buffer<-ggplot()+
  geom_sf(data=m_buffer, fill="grey", alpha=0.4, color="grey")+
  geom_path(data=m_encounters, aes(E, N), color="grey", alpha=0.5)+
  geom_sf(data=m_encounters, aes(color=meet_id),size=0.5)+
  #facet_wrap(~meet_id)+
  theme(legend.position = "none")+
  coord_sf(datum=2056)+
  xlim(2568000, 2575000)+
  ylim(1202000, 1208000)
m_encounters_buffer
```

```{r }
# deriving movement parameters
f_encounters<- f_encounters %>%
  group_by(meet_id) %>%
  mutate(timelag = as.numeric(difftime(lead(DatetimeRound),DatetimeRound, units = "secs")),
         steplength=sqrt((E-lead(E,1))^2+(N-lead(N,1))^2),
         speed=steplength/timelag)

m_encounters<- m_encounters %>%
  group_by(meet_id) %>%
  mutate(timelag = as.numeric(difftime(lead(DatetimeRound),DatetimeRound, units = "secs")),
         steplength=sqrt((E-lead(E,1))^2+(N-lead(N,1))^2),
         speed=steplength/timelag)

#plotting the distribution of speed within 12h
f_hist_speed<- ggplot(f_encounters,aes(speed))+
  geom_histogram(binwidth=0.05)+
  xlim(c(0,1))+
  labs(title="Speed [m/s] of female boars")

m_hist_speed<- ggplot(m_encounters,aes(speed))+
  geom_histogram(binwidth=0.05)+
  xlim(c(0,1))+
  labs(title="Speed [m/s] of male boars")
```


```{r }
# Selection of the rows within 1h after the encounter
f_1h<- f_encounters %>%
  filter(rowid.x== rowid.y | rowid.x== rowid.y+1 | 
           rowid.x== rowid.y+2 | rowid.x== rowid.y+3) %>%
  group_by(meet_id) %>%
  mutate(encounter= "later")
m_1h<- m_encounters %>%
  filter(rowid.x== rowid.y | rowid.x== rowid.y+1 | 
           rowid.x== rowid.y+2 | rowid.x== rowid.y+3) %>%
  group_by(meet_id)%>%
  mutate(encounter= "later")

# selection of the rows 1h before the encounter
f_1h_sub<- f_encounters %>%
  filter(rowid.x %in% c(rowid.y-1, rowid.y-2, rowid.y-3, rowid.y-4)) %>%
  group_by(meet_id)%>%
  mutate(encounter= "before")
m_1h_sub<- m_encounters %>%
  filter(rowid.x== rowid.y-1 | rowid.x== rowid.y-2 | 
           rowid.x== rowid.y-3 | rowid.x== rowid.y-4) %>%
  group_by(meet_id)%>%
  mutate(encounter= "before")


# selection of the 6h after the encounter (because of different sampling intervals during the day it's not exactly 6h, but close enough (hopefully))
f_6h<- f_encounters %>%
  filter(rowid.x %in% c(rowid.y, rowid.y+1, rowid.y+2, rowid.y+3, rowid.y+4,
                        rowid.y+5, rowid.y+6, rowid.y+7, rowid.y+8,
                        rowid.y+9, rowid.y+10, rowid.y+11, rowid.y+12,
                        rowid.y+13, rowid.y+14, rowid.y+15, rowid.y+16,
                        rowid.y+17, rowid.y+18, rowid.y+19, rowid.y+20,
                        rowid.y+21, rowid.y+22, rowid.y+23, rowid.y+24)) %>%
  group_by(meet_id)
m_6h<- m_encounters %>%
  filter(rowid.x %in% c(rowid.y, rowid.y+1, rowid.y+2, rowid.y+3, rowid.y+4,
                        rowid.y+5, rowid.y+6, rowid.y+7, rowid.y+8,
                        rowid.y+9, rowid.y+10, rowid.y+11, rowid.y+12,
                        rowid.y+13, rowid.y+14, rowid.y+15, rowid.y+16,
                        rowid.y+17, rowid.y+18, rowid.y+19, rowid.y+20,
                        rowid.y+21, rowid.y+22, rowid.y+23, rowid.y+24)) %>%
  group_by(meet_id)

```
```{r eval=FALSE}
# converting the f/m_encounter DFs to csv files to load them anytime (also: det_buffer, f/m_active, and f/m_unique)

f_encounters_csv <- f_encounters %>%
  st_drop_geometry() %>%
  write.csv("C:/Users/sarah/OneDrive - ZHAW/ACLS/Track_Module/project/Project-template-master/Project-template-master/f_encounters.csv", row.names = FALSE)

m_encounters_csv <- m_encounters %>%
  st_drop_geometry() %>%
  write.csv("C:/Users/sarah/OneDrive - ZHAW/ACLS/Track_Module/project/Project-template-master/Project-template-master/m_encounters.csv", row.names = FALSE)

f_active_csv <- f_active %>%
  st_drop_geometry() %>%
  write.csv("C:/Users/sarah/OneDrive - ZHAW/ACLS/Track_Module/project/Project-template-master/Project-template-master/f_active.csv", row.names = FALSE)
m_active_csv <- m_active %>%
  st_drop_geometry() %>%
  write.csv("C:/Users/sarah/OneDrive - ZHAW/ACLS/Track_Module/project/Project-template-master/Project-template-master/m_active.csv", row.names = FALSE)

det_buffer_csv <- det_buffer %>%
  st_drop_geometry() %>%
  write.csv("C:/Users/sarah/OneDrive - ZHAW/ACLS/Track_Module/project/Project-template-master/Project-template-master/det_buffer.csv", row.names = FALSE)
```




# Statistics

comparisons of male/ female: speed 1h after encounter, distance 1h after encounter, distance by volume, distance by modus, (if possible) similarities of trajectories coming from the same deterrence locations (I don't have the forest/field edges, but possibly they run straight to the next cover which means their trajectories would be really similar) 

### Comparison speeds of female and male wild boars within 1h of the encounter

H0: The difference in the speeds of female and male wild boars have no systematic reason but occurred at random.
H1: The difference in the speeds of female and male wild boars have a systematic reason.
```{r }
# testing for normality
shapiro.test(f_1h$speed)
shapiro.test(m_1h$speed)
# since f_speeds data not normal, independent --> wilcox
wilcox.test(f_1h$speed, m_1h$speed)
# H0 TRUE: speeds f/m not systematically different

f_1<-f_1h %>%
  st_drop_geometry() %>%
  ungroup() %>%
  mutate(sex="female")%>%
  select(speed, sex)
m_1<-m_1h %>%
  st_drop_geometry() %>% 
  ungroup() %>%
  mutate(sex="male") %>%
  select(speed, sex)
comparison<- rbind(f_1, m_1)
comparison<-comparison %>%
  group_by(sex)
ggplot(data=comparison, aes(sex, speed, fill=sex))+
  geom_boxplot()+
  labs(title="Comparison of speed 1h after the encounter with a deterrence")+
  ylab("speed [m/s]")

```

Does volume or modus have an influence on speed 1h after encounter
```{r }
# since we know the data does not have normal distribution -->
#females
kruskal.test(speed~modus, data=f_1h)#p-value =0.6423
kruskal.test(speed~lautstaerke, data=f_1h) # p-value= 0.005955 speed differs significantly with volume

#males
kruskal.test(speed~modus, data=m_1h) #p-value = 0.8446
kruskal.test(speed~lautstaerke, data=m_1h) # p-value = 0.02788 speed differs significantly with volume


# boxplots speed-modus
f_speed_modus<- f_1h %>%
  group_by(modus) %>%
  ggplot() + 
  geom_boxplot(aes(x=modus, y=speed, group=modus, fill=modus)) +
  ylab("speed [m/s]")

m_speed_modus<- m_1h %>%
  group_by(modus)%>%
  ggplot()+
  geom_boxplot(aes(x=modus, y=speed, group=modus, fill=modus)) +
  ylab("speed [m/s]")

# boxplots speed-lautstaerke
f_speed_vol<- f_1h %>%
  group_by(lautstaerke) %>%
  ggplot() + 
  geom_boxplot(aes(x=lautstaerke, y=speed, group=lautstaerke, fill=as.factor(lautstaerke))) +
  ylab("speed [m/s]")

m_speed_vol<- m_1h %>%
  group_by(lautstaerke)%>%
  ggplot()+
  geom_boxplot(aes(x=lautstaerke, y=speed, group=lautstaerke, fill=as.factor(lautstaerke)))+
  ylab("speed [m/s]")
```


Comparison of distance 1h after encounter
```{r }
f_1h_dist<-f_1h %>%
  st_drop_geometry() %>%
  group_by(meet_id, lautstaerke, modus)%>%
  summarise(dist=sum(steplength, na.rm=T))

m_1h_dist<-m_1h %>%
  st_drop_geometry() %>%
  group_by(meet_id, lautstaerke, modus)%>%
  summarise(dist=sum(steplength, na.rm=T))


# testing for normality
shapiro.test(f_1h_dist$dist) #not normal
shapiro.test(m_1h_dist$dist) # normal (how, but whatever)
# since f_speeds data not normal, independent --> wilcox
wilcox.test(f_1h_dist$dist, m_1h_dist$dist)
# H0 TRUE: distance f/m not systematically different

f_1_dist<-f_1h_dist %>%
  ungroup() %>%
  mutate(sex="female")%>%
  select(dist, sex)
m_1_dist<-m_1h_dist %>%
  ungroup() %>%
  mutate(sex="male") %>%
  select(dist, sex)
comparison_dist<- rbind(f_1_dist, m_1_dist)
comparison_dist<-comparison_dist %>%
  group_by(sex)
ggplot(data=comparison_dist, aes(sex, dist, fill=sex))+
  geom_boxplot()+
  labs(title="Comparison of flight distance within one hour \n of the encounter with a deterrence")+
  ylab("distance [m]")
```
Does volume or modus have an influence on distance 1h after encounter
```{r }
# since we know the data does not have normal distribution -->
#females
kruskal.test(dist~modus, data=f_1h_dist)#p-value = 0.398
kruskal.test(dist~lautstaerke, data=f_1h_dist) # p-value= 0.3389

#males
kruskal.test(dist~modus, data=m_1h_dist) #p-value = 0.6948
kruskal.test(dist~lautstaerke, data=m_1h_dist) # p-value = 0.03573 distance differs significantly with volume

# BEWARE OF THE DIFFERENT COLORS - FIX THIS
# boxplots dist-modus
f_dist_modus<- f_1h_dist %>%
  group_by(modus) %>%
  ggplot() + 
  geom_boxplot(aes(x=modus, y=dist, group=modus, fill=modus))

m_dist_modus<- m_1h_dist %>%
  group_by(modus)%>%
  ggplot()+
  geom_boxplot(aes(x=modus, y=dist, group=modus, fill=modus))

# boxplots dist-lautstaerke
f_dist_vol<- f_1h_dist %>%
  group_by(lautstaerke) %>%
  ggplot() + 
  geom_boxplot(aes(x=lautstaerke, y=dist, group=lautstaerke, fill=as.factor(lautstaerke)))

m_dist_vol<- m_1h_dist %>%
  group_by(lautstaerke)%>%
  ggplot()+
  geom_boxplot(aes(x=lautstaerke, y=dist, group=lautstaerke, fill=as.factor(lautstaerke)))
```

Comparison of trajectories from the same deterrence location

```{r }


ggplot()+
  geom_sf(data=f_buffer, fill="grey", alpha=.4, color="grey")+
  geom_sf(data=f_1h, aes(color=as.factor(meet_id)), size=.7, shape=1)+
  facet_wrap(~id) +
  theme(legend.position = "none")+
  coord_sf(datum=2056)


ggplot()+
  geom_sf(data=m_buffer, fill="grey", alpha=.4, color="grey")+
  geom_sf(data=m_encounters, aes(color=as.factor(meet_id)), size=.7, shape=1)+
  facet_wrap(~id) +
  theme(legend.position = "none")+
  coord_sf(datum=2056)

# why tf are there soo many encounter in the female side? 
```

```{r }
# turning these dataframes into dataframes with separate traectories beginning at the same buffer
f_6<-f_6h %>%
  st_drop_geometry()%>%
  mutate(Datetime_int=as.integer(DatetimeRound)) %>%
  select(E, N, Datetime_int, meet_id, id) %>%
  ungroup()
m_6<-m_6h %>%
  st_drop_geometry()%>%
  mutate(Datetime_int=as.integer(DatetimeRound)) %>%
  select(E, N, Datetime_int, meet_id, id) %>%
  ungroup()
f_split<-split(f_6, f_6$id)
m_split<-split(m_6, m_6$id)

unique(m_split[[1]]$meet_id)

df_to_traj <- function(df, traj){
  df %>%
    filter(meet_id == traj) %>%
    select(E, N, Datetime_int) %>%
    as.matrix()
}

b1_meet1 <- df_to_traj(m_split[[1]], 1)


```







   





